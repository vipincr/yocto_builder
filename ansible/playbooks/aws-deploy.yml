---
- name: Deploy Yocto Builder to AWS EC2
  hosts: aws_ec2_instances
  become: yes
  
  vars:
    nginx_server_name: "{{ hostvars[inventory_hostname]['public_ip'] | default(ansible_host) }}"
    nextauth_url: "https://{{ hostvars[inventory_hostname]['public_ip'] | default(ansible_host) }}"
    builds_directory: "/data/builds"
    logs_directory: "/var/log/yocto_builder"
    key_path: "{{ lookup('env', 'AWS_EC2_KEY_PATH') | default('../../.secrets/ec2_vipinr.pem') }}"
    app_repo: "{{ lookup('env', 'APP_REPO') | default('https://github.com/your-org/yocto_builder.git') }}"
    app_branch: "{{ lookup('env', 'APP_BRANCH') | default('main') }}"
    app_user: yocto
    app_group: yocto
    app_home: /opt/yocto_builder
    postgresql_user: yocto_admin
    postgresql_password: "{{ lookup('env', 'POSTGRESQL_PASSWORD') | default('changeme') }}"
    postgresql_host: localhost
    postgresql_port: 5432
    postgresql_db: yocto_builder
    nextauth_secret: "{{ lookup('env', 'NEXTAUTH_SECRET') | default('changeme-secret-key-change-in-production') }}"
    github_client_id: "{{ lookup('env', 'GITHUB_CLIENT_ID') | default('') }}"
    github_client_secret: "{{ lookup('env', 'GITHUB_CLIENT_SECRET') | default('') }}"
    google_client_id: "{{ lookup('env', 'GOOGLE_CLIENT_ID') | default('') }}"
    google_client_secret: "{{ lookup('env', 'GOOGLE_CLIENT_SECRET') | default('') }}"
    build_container_cpus: "{{ lookup('env', 'BUILD_CONTAINER_CPUS') | default(6) | int }}"
    build_container_memory: "{{ lookup('env', 'BUILD_CONTAINER_MEMORY') | default('28g') }}"
    pm2_instances: 1

  pre_tasks:
    - name: Display deployment info
      debug:
        msg: "Deploying to {{ inventory_hostname }} ({{ ansible_host }})"

    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

  roles:
    - common
    - docker
    - postgresql
    - nodejs
    - nginx
    - yocto_builder

  post_tasks:
    - name: Update nginx server name with public IP
      set_fact:
        nginx_server_name: "{{ hostvars[inventory_hostname]['public_ip'] }}"

    - name: Display deployment status
      debug:
        msg:
          - "Deployment completed!"
          - "Application URL: https://{{ hostvars[inventory_hostname]['public_ip'] }}"
          - "SSH: ssh -i {{ key_path }} ubuntu@{{ hostvars[inventory_hostname]['public_ip'] }}"
          - "Note: SSL certificate will be set up on first access or run certbot manually"

    - name: Verify services are running
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - postgresql
        - docker
        - nginx
      register: service_status

    - name: Display service status
      debug:
        var: service_status

