---
- name: Deploy YoctoBuilder to AWS EC2
  hosts: "{{ target_hosts | default('aws_ec2_instances') }}"
  become: yes
  
  vars_files:
    - ../group_vars/all.yml
  
  vars:
    # AWS-specific overrides
    nginx_server_name: "{{ hostvars[inventory_hostname]['public_ip'] | default(ansible_host) }}"
    nextauth_url: "{{ 'https://' if nginx_ssl_enabled | default(false) else 'http://' }}{{ hostvars[inventory_hostname]['public_ip'] | default(ansible_host) }}"
    app_repo: "{{ lookup('env', 'APP_REPO') | default(app_repo) }}"
    app_branch: "{{ lookup('env', 'APP_BRANCH') | default(app_branch | default('main')) }}"
    # NOTE: lookup('env', ...) returns "" when unset; default(..., true) treats "" as undefined.
    postgresql_password: "{{ lookup('env', 'POSTGRESQL_PASSWORD') | default(postgresql_password, true) }}"
    nginx_ssl_enabled: "{{ lookup('env', 'NGINX_SSL_ENABLED') | default('false') | bool }}"

  pre_tasks:
    - name: Display deployment info
      debug:
        msg:
          - "Deploying YoctoBuilder to {{ inventory_hostname }} ({{ ansible_host }})"
          - "Repository: {{ app_repo }} (branch: {{ app_branch }})"
          - "Application home: {{ app_home }}"

    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

    - name: Gather system facts
      setup:

  roles:
    - common
    - docker
    - postgresql
    - nodejs
    - nginx
    - yocto_builder

  post_tasks:
    - name: Update nginx server name with public IP
      set_fact:
        nginx_server_name: "{{ hostvars[inventory_hostname]['public_ip'] }}"

    - name: Display deployment status
      debug:
        msg:
          - "=========================================="
          - "YoctoBuilder Deployment Complete!"
          - "=========================================="
          - "Instance: {{ inventory_hostname }} ({{ ansible_host }})"
          - "Application URL: {{ nextauth_url }}"
          - "SSH: ssh -i {{ key_path }} ec2-user@{{ ansible_host }}"
          - "PM2 Status: Check with 'pm2 list' on the server"
          - ""
          - "Next steps:"
          - "  1. Access the application at {{ nextauth_url }}"
          - "  2. Complete initial setup if this is first deployment"
          - "  3. Configure OAuth providers in settings (admin only)"
          - ""
          - "Note: SSL certificate will be configured automatically"
          - "      or run certbot manually for custom domain"

    - name: Verify services are running
      systemd:
        name: "{{ item }}"
        state: started
      loop:
        - postgresql
        - docker
        - nginx
      register: service_status

    - name: Display service status
      debug:
        var: service_status

