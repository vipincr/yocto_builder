---
# Full deployment playbook - handles both provisioning and deployment
# This playbook can be run multiple times safely (idempotent)
- name: Full AWS Deployment for YoctoBuilder
  hosts: localhost
  connection: local
  gather_facts: no
  become: no
  
  vars:
    instance_info_file: "{{ playbook_dir | dirname | dirname }}/.aws-instance-info"
    
  tasks:
    - name: Lookup existing EC2 instance by Name tag
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region | default('ap-south-1') }}"
        filters:
          "tag:Name": "{{ instance_name | default('yocto-builder') }}"
          instance-state-name: [running, stopped]
      register: existing_instance
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        AWS_REGION: "{{ aws_region | default('ap-south-1') }}"
      failed_when: false
      changed_when: false

    - name: Check if instance already exists in file
      stat:
        path: "{{ instance_info_file }}"
      register: instance_info_exists
      delegate_to: localhost

    - name: Load existing instance info from file
      include_vars:
        file: "{{ instance_info_file }}"
      when: instance_info_exists.stat.exists
      register: loaded_instance_info
      failed_when: false

    - name: Use existing instance from AWS lookup
      set_fact:
        target_instance_id: "{{ existing_instance.instances[0].instance_id }}"
        target_instance_ip: "{{ existing_instance.instances[0].public_ip_address | default(existing_instance.instances[0].private_ip_address) }}"
        target_instance_state: "{{ existing_instance.instances[0].state.name }}"
      when: existing_instance.instances | default([]) | length > 0

    - name: Start existing stopped instance
      amazon.aws.ec2_instance:
        instance_ids:
          - "{{ target_instance_id }}"
        state: running
        wait: yes
        wait_timeout: 600
      when: target_instance_id is defined and target_instance_state | default('') == 'stopped'
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        AWS_REGION: "{{ aws_region | default('ap-south-1') }}"
      register: instance_started

    - name: Get instance details after starting
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region | default('ap-south-1') }}"
        instance_ids:
          - "{{ target_instance_id }}"
      when: target_instance_id is defined and target_instance_state | default('') == 'stopped'
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env', 'AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env', 'AWS_SECRET_ACCESS_KEY') }}"
        AWS_REGION: "{{ aws_region | default('ap-south-1') }}"
      register: instance_details_after_start

    - name: Update instance IP after starting
      set_fact:
        target_instance_ip: "{{ instance_details_after_start.instances[0].public_ip_address | default(instance_details_after_start.instances[0].private_ip_address) }}"
      when: target_instance_id is defined and target_instance_state | default('') == 'stopped' and instance_details_after_start.instances | default([]) | length > 0

    - name: Provision new EC2 instance (if no existing instance found)
      include_role:
        name: aws_ec2
      when: existing_instance.instances | default([]) | length == 0 and (not instance_info_exists.stat.exists or not (loaded_instance_info | default({})).instance_id | default('') | length > 0)
      tags:
        - provision

    - name: Load instance info after provisioning
      include_vars:
        file: "{{ instance_info_file }}"
      when: not instance_info_exists.stat.exists or not (loaded_instance_info | default({})).instance_id | default('') | length > 0
      register: new_instance_info

    - name: Set instance variables from file (if not already set from AWS lookup)
      set_fact:
        target_instance_ip: "{{ (new_instance_info | default({})).public_ip | default((loaded_instance_info | default({})).public_ip | default('')) }}"
        target_instance_id: "{{ (new_instance_info | default({})).instance_id | default((loaded_instance_info | default({})).instance_id | default('')) }}"
      when: target_instance_id is not defined

    - name: Fail if no instance IP
      fail:
        msg: "No instance IP found. Provision an instance first."
      when: target_instance_ip | default('') | length == 0

    - name: Save instance info to file
      copy:
        content: |
          instance_id={{ target_instance_id }}
          public_ip={{ target_instance_ip }}
        dest: "{{ instance_info_file }}"
      delegate_to: localhost

    - name: Update inventory with instance IP
      copy:
        content: |
          all:
            children:
              aws_ec2_instances:
                hosts:
                  yocto-builder:
                    ansible_host: {{ target_instance_ip }}
                    ansible_user: ubuntu
                    ansible_ssh_private_key_file: {{ key_path }}
                    public_ip: {{ target_instance_ip }}
        dest: "{{ playbook_dir | dirname }}/inventory/aws-ec2-static.yml"
      delegate_to: localhost

    - name: Wait for SSH to be available
      wait_for:
        host: "{{ target_instance_ip }}"
        port: 22
        delay: 10
        timeout: 300
      connection: local

- name: Deploy application to EC2
  hosts: aws_ec2_instances
  become: yes
  gather_facts: yes
  
  vars_files:
    - ../group_vars/all.yml
    - ../group_vars/aws.yml
  
  vars:
    platform: aws
  
  pre_tasks:
    - name: Wait for system to be ready
      wait_for_connection:
        timeout: 300

  roles:
    - common
    - docker
    - postgresql
    - nodejs
    - nginx
    - yocto_builder

  post_tasks:
    - name: Display deployment status
      debug:
        msg:
          - "=========================================="
          - "YoctoBuilder Deployment Complete!"
          - "=========================================="
          - "Instance: {{ inventory_hostname }} ({{ ansible_host }})"
          - "Application URL: {{ nextauth_url }}"
          - "SSH: ssh -i {{ key_path }} ubuntu@{{ ansible_host }}"
          - "PM2 Status: Check with 'pm2 list' on the server"
          - ""
          - "Next steps:"
          - "  1. Access the application at {{ nextauth_url }}"
          - "  2. Complete initial setup if this is first deployment"
          - "  3. Configure OAuth providers in settings (admin only)"
